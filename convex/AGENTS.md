# Backend Agent Rules (`convex/`)

> **Owner:** OPUS  
> **Status:** final  
> **Last updated:** 2026-02-10  
> **Scope:** All files under `convex/` (except `_generated/`).

---

## Schema Patterns

- **Schema source of truth:** `convex/schema.ts`
- Never modify `convex/_generated/` — these are auto-generated by `npx convex dev`
- Use Convex validators (`v.string()`, `v.number()`, etc.) for all function arguments
- Reference `docs/design-docs/systems/data-model-spec.md` for table relationships and design intent

## Query / Mutation Conventions

### Naming
- Queries: `get*`, `list*` (e.g., `getCase`, `listCases`)
- Mutations: `create*`, `update*`, `delete*` (e.g., `createCase`)
- Actions: `do*`, `send*`, `process*` (e.g., `processPayment`)
- Internal: `_internal*` prefix — admin/system only, not callable from client

### Security Rules
1. **All mutations require auth** — use `getAuthUserId(ctx)` from `convex/lib/auth.ts`
2. **No PII in public queries** — never return email/phone in public-facing results
3. **Admin endpoints use `internalMutation`** — not callable from client
4. **Ownership checks** — mutations must validate user owns the resource before modifying
5. **Rate limit abuse-prone endpoints** — reports, uploads, AI actions

### Pagination
- Use Convex cursor-based pagination for list queries
- Default page size: 20 items
- Return `{ items, cursor, hasMore }` shape

## Auth Helper

```ts
import { getAuthUserId } from "./lib/auth";

// In any mutation:
const userId = await getAuthUserId(ctx);
if (!userId) throw new Error("Not authenticated");
```

## File Organization

| File | Purpose |
|------|---------|
| `convex/schema.ts` | Complete data model (all tables) |
| `convex/lib/auth.ts` | Auth helpers (getAuthUserId) |
| `convex/cases.ts` | Case CRUD + lifecycle |
| `convex/donations.ts` | Donation checkout + webhook |
| `convex/http.ts` | HTTP endpoints (Stripe webhooks, Clerk webhooks) |
| `convex/users.ts` | User profile management |
| `convex/reports.ts` | Report/moderation system |
| `convex/community.ts` | Community posts + threads |
| `convex/storage.ts` | File upload handling |
| `convex/notifications.ts` | Notification creation + delivery |

## What NOT To Do

- Never edit `convex/_generated/` files
- Never expose `internalMutation` to client
- Never return raw user emails in public queries
- Never call external APIs directly in queries/mutations — use actions
- Never skip auth checks in mutations
